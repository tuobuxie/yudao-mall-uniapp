import{r as e,e as s,j as t,f as a,w as o,k as l,p as n,t as i,A as r,u as c,l as u,F as d,m,i as p,c as g,cj as f,s as h,b5 as y,g as v,ad as _,at as w,au as T,q as x,B as b,X as k,v as S,a3 as M,T as I,ck as C,E as $,G as D,z as E,U as j,V as B,y as V,bj as F,aS as N,D as O,H as R,aj as L,a_ as z,a4 as A,a9 as P,cl as U,cm as H,cn as Y,co as q,cp as X,c2 as G,cq as J,bq as K}from"./index-Ch_jkemp.js";import{_ as W,c as Z,b as Q,S as ee}from"./s-layout.Ckk_oEQ_.js";import{_ as se}from"./mp-html.DtmLWHjR.js";import{_ as te}from"./su-image.BfvOhm0y.js";import{_ as ae}from"./s-goods-item.DcngbUKh.js";import{o as oe,m as le,f as ne}from"./useGoods.CmR2wUi_.js";import{_ as ie}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as re}from"./s-uploader.pQcKAWFG.js";import{_ as ce}from"./uni-load-more.C8hvkNiT.js";import{c as ue}from"./concat.B-rUqbX7.js";import"./choose-and-upload-file.Bi8hjSC9.js";const de={TEXT:1,IMAGE:2,VOICE:3,VIDEO:4,SYSTEM:5,PRODUCT:10,ORDER:11},me={MEMBER:1,ADMIN:2},pe="kefu_message_type",ge="kefu_message_read_status_change",fe=[{name:"[笑掉牙]",file:"xiaodiaoya.png"},{name:"[可爱]",file:"keai.png"},{name:"[冷酷]",file:"lengku.png"},{name:"[闭嘴]",file:"bizui.png"},{name:"[生气]",file:"shengqi.png"},{name:"[惊恐]",file:"jingkong.png"},{name:"[瞌睡]",file:"keshui.png"},{name:"[大笑]",file:"daxiao.png"},{name:"[爱心]",file:"aixin.png"},{name:"[坏笑]",file:"huaixiao.png"},{name:"[飞吻]",file:"feiwen.png"},{name:"[疑问]",file:"yiwen.png"},{name:"[开心]",file:"kaixin.png"},{name:"[发呆]",file:"fadai.png"},{name:"[流泪]",file:"liulei.png"},{name:"[汗颜]",file:"hanyan.png"},{name:"[惊悚]",file:"jingshu.png"},{name:"[困~]",file:"kun.png"},{name:"[心碎]",file:"xinsui.png"},{name:"[天使]",file:"tianshi.png"},{name:"[晕]",file:"yun.png"},{name:"[啊]",file:"a.png"},{name:"[愤怒]",file:"fennu.png"},{name:"[睡着]",file:"shuizhuo.png"},{name:"[面无表情]",file:"mianwubiaoqing.png"},{name:"[难过]",file:"nanguo.png"},{name:"[犯困]",file:"fankun.png"},{name:"[好吃]",file:"haochi.png"},{name:"[呕吐]",file:"outu.png"},{name:"[龇牙]",file:"ziya.png"},{name:"[懵比]",file:"mengbi.png"},{name:"[白眼]",file:"baiyan.png"},{name:"[饿死]",file:"esi.png"},{name:"[凶]",file:"xiong.png"},{name:"[感冒]",file:"ganmao.png"},{name:"[流汗]",file:"liuhan.png"},{name:"[笑哭]",file:"xiaoku.png"},{name:"[流口水]",file:"liukoushui.png"},{name:"[尴尬]",file:"ganga.png"},{name:"[惊讶]",file:"jingya.png"},{name:"[大惊]",file:"dajing.png"},{name:"[不好意思]",file:"buhaoyisi.png"},{name:"[大闹]",file:"danao.png"},{name:"[不可思议]",file:"bukesiyi.png"},{name:"[爱你]",file:"aini.png"},{name:"[红心]",file:"hongxin.png"},{name:"[点赞]",file:"dianzan.png"},{name:"[恶魔]",file:"emo.png"}];let he={};fe.forEach(((e,s)=>{he[Math.floor(s/30)+1]||(he[Math.floor(s/30)+1]=[]),he[Math.floor(s/30)+1].push(e)}));const ye={__name:"goods",props:{goodsData:{type:Object,default:{}}},setup:o=>(l,n)=>{const i=e(s("s-goods-item"),ae);return t(),a(i,{title:o.goodsData.spuName,img:o.goodsData.picUrl,price:o.goodsData.price,skuText:o.goodsData.introduction,priceColor:"#FF3000",titleWidth:400},null,8,["title","img","price","skuText"])}},ve=ie({__name:"order",props:{orderData:{type:Object,default:{}}},setup:g=>(f,h)=>{const y=p,v=e(s("s-goods-item"),ae);return t(),a(y,{class:"bg-white order-list-card-box ss-r-10 ss-m-t-14 ss-m-20",key:g.orderData.id},{default:o((()=>[l(y,{class:"order-card-header ss-flex ss-col-center ss-row-between ss-p-x-20"},{default:o((()=>[l(y,{class:"order-no"},{default:o((()=>[n("订单号："+i(g.orderData.no),1)])),_:1}),l(y,{class:r(["order-state ss-font-26",c(oe)(g.orderData)])},{default:o((()=>[n(i(c(le)(g.orderData)),1)])),_:1},8,["class"])])),_:1}),(t(!0),u(d,null,m(g.orderData.items,(e=>(t(),a(y,{class:"border-bottom",key:e.id},{default:o((()=>[l(v,{img:e.picUrl,title:e.spuName,skuText:e.properties.map((e=>e.valueName)).join(" "),price:e.price,num:e.count},null,8,["img","title","skuText","price","num"])])),_:2},1024)))),128)),l(y,{class:"pay-box ss-m-t-30 ss-flex ss-row-right ss-p-r-20"},{default:o((()=>[l(y,{class:"ss-flex ss-col-center"},{default:o((()=>[l(y,{class:"discounts-title pay-color"},{default:o((()=>[n("共 "+i(g.orderData.productCount)+" 件商品,总金额:",1)])),_:1}),l(y,{class:"discounts-money pay-color"},{default:o((()=>[n(" ￥"+i(c(ne)(g.orderData.payPrice)),1)])),_:1})])),_:1})])),_:1})])),_:1})}},[["__scopeId","data-v-0dc0a8fd"]]),_e=ie({__name:"messageListItem",props:{message:{type:Object,default:()=>({})},messageIndex:{type:Number,default:0},messageList:{type:Array,default:()=>[]}},setup(d){const m=d,b=g((()=>e=>f(e.content))),k=g((()=>h.$store("user").userInfo)),S=g((()=>(e,s)=>{if(c(m.messageList)[s+1]){return y(c(m.messageList)[s+1].createTime).fromNow()!==y(c(e).createTime).fromNow()}return!1})),M=g((()=>{const e=new Map;return fe.forEach((s=>{e.set(s.name,s.file)})),e}));const I=g((()=>m.message.contentType===de.TEXT?function(e){let s=e;if("object"!=typeof s){let e=/\[(.+?)]/g,t=s.match(e);t&&t.forEach((e=>{const t=M.value.get(e)||"";t&&(s=s.replace(e,`<img class="chat-img" style="width: 24px;height: 24px;margin: 0 3px;vertical-align: middle;" src="${h.$url.cdn("/static/img/chat/emoji/"+t)}"/>`))}))}return s}(b.value(m.message).text||m.message.content):m.message.content));return(m,g)=>{const f=p,y=x,M=e(s("mp-html"),se),C=e(s("su-image"),te);return t(),a(f,{class:"chat-box"},{default:o((()=>[l(f,{class:"message-item ss-flex-col scroll-item"},{default:o((()=>[l(f,{class:"ss-flex ss-row-center ss-col-center"},{default:o((()=>[d.message.contentType===c(de).SYSTEM?(t(),a(f,{key:0,class:"system-message"},{default:o((()=>[n(i(d.message.content),1)])),_:1})):v("",!0),d.message.contentType!==c(de).SYSTEM&&S.value(d.message,d.messageIndex)?(t(),a(f,{key:1,class:"date-message"},{default:o((()=>[n(i(c(_)(d.message.createTime)),1)])),_:1})):v("",!0)])),_:1}),d.message.contentType!==c(de).SYSTEM?(t(),a(f,{key:0,class:r(["ss-flex ss-col-top",[d.message.senderType===c(me).ADMIN?"ss-row-left":d.message.senderType===c(me).MEMBER?"ss-row-right":""]])},{default:o((()=>[w(l(y,{class:"chat-avatar ss-m-r-24",src:c(h).$url.cdn(d.message.senderAvatar)||c(h).$url.static(""),mode:"aspectFill","lazy-load":""},null,8,["src"]),[[T,d.message.senderType===c(me).ADMIN]]),d.message.contentType===c(de).TEXT?(t(),a(f,{key:0,class:r(["message-box",{admin:d.message.senderType===c(me).ADMIN}])},{default:o((()=>[l(M,{content:I.value,domain:c(h).$url.cdn(""),"lazy-load":""},null,8,["content","domain"])])),_:1},8,["class"])):v("",!0),d.message.contentType===c(de).IMAGE?(t(),a(f,{key:1,class:r(["message-box",{admin:d.message.senderType===c(me).ADMIN}]),style:{width:"200rpx"}},{default:o((()=>[l(C,{class:"message-img",isPreview:"",previewList:[c(h).$url.cdn(b.value(d.message).picUrl||d.message.content)],current:0,src:c(h).$url.cdn(b.value(d.message).picUrl||d.message.content),height:200,width:200,mode:"aspectFill"},null,8,["previewList","src"])])),_:1},8,["class"])):v("",!0),d.message.contentType===c(de).PRODUCT?(t(),u("div",{key:2,class:"ss-m-b-10"},[l(ye,{goodsData:b.value(d.message),onClick:g[0]||(g[0]=e=>c(h).$router.go("/pages/goods/index",{id:b.value(d.message).spuId}))},null,8,["goodsData"])])):v("",!0),d.message.contentType===c(de).ORDER?(t(),a(ve,{key:3,orderData:b.value(d.message),onClick:g[1]||(g[1]=e=>c(h).$router.go("/pages/order/detail",{id:b.value(d.message).id}))},null,8,["orderData"])):v("",!0),d.message.senderType===c(me).MEMBER?(t(),a(y,{key:4,class:"chat-avatar ss-m-l-24",src:c(h).$url.cdn(k.value.avatar)||c(h).$url.static("/static/img/shop/chat/default.png"),mode:"aspectFill"},null,8,["src"])):v("",!0)])),_:1},8,["class"])):v("",!0)])),_:1})])),_:1})}}},[["__scopeId","data-v-cc7e8136"]]),we=ie({__name:"messageList",setup(r,{expose:c}){b((e=>({c9be5700:R.value})));const{safeAreaInsets:f}=h.$platform.device,y=f.bottom+"px",w=k([]),T=k(!1),x=k(!1),j=k(!1),B=k(!1),V=k(!0),F=k(0),N=k({top:0,oldTop:0}),O=S({no:1,limit:20,createTime:void 0}),R=g((()=>{const e="calc(100vh - 150px - "+y+")";return F.value>0?`calc(${e} - ${F.value}px)`:e})),L=async()=>{B.value=!0;try{const{data:e}=await C.getKefuMessageList(O);if($(e))return void(V.value=!1);if(O.no>1&&j.value){const s=[];for(const t of e)w.value.some((e=>e.id===t.id))||s.push(t);return w.value=[...s,...w.value],void(j.value=!1)}if(O.no>1){e.length<O.limit&&(V.value=!1);const s=e.filter((e=>!w.value.some((s=>s.id===e.id))));s.length>0&&(w.value=[...w.value,...s])}else w.value=e,e.length<O.limit&&(V.value=!1);e.slice(-1).length>0&&(O.createTime=_(e.slice(-1)[0].createTime))}finally{B.value=!1}},z=async()=>{!B.value&&V.value&&(O.no+=1,await L())},A=()=>{N.value.top=N.value.oldTop,setTimeout((()=>{N.value.top=0}),200),T.value=!1},P=e=>{F.value=e,e>0&&A()};c({getMessageList:L,refreshMessageList:async e=>{void 0!==e?(w.value.unshift(e),x.value=!0):(O.createTime=void 0,j.value=!0,await L()),O.no>1?T.value=!0:A()}});const U=e=>{const{scrollTop:s}=e.detail;N.value.oldTop=s,T.value=s>100};return M((()=>{O.no=1,N.value={top:0,oldTop:0},L(),window.addEventListener("resize",(()=>{if(!document.activeElement||"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName)P(0);else{const e=window.innerHeight-(window.visualViewport?window.visualViewport.height:window.innerHeight);P(e>0?e:0)}}))})),(r,c)=>{const g=D,f=p,h=E,y=e(s("su-fixed"),W);return t(),u(d,null,[l(h,{"scroll-top":N.value.top,class:"chat-scroll-view","scroll-y":"","refresher-enabled":!1,onScroll:U,onScrolltolower:z,style:{transform:"scaleY(-1)"}},{default:o((()=>[l(f,{class:"message-container"},{default:o((()=>[B.value?(t(),a(f,{key:0,class:"loading-more",style:{transform:"scaleY(-1)"}},{default:o((()=>[l(g,null,{default:o((()=>[n("加载中...")])),_:1})])),_:1})):v("",!0),l(f,{class:"message-list"},{default:o((()=>[(t(!0),u(d,null,m(w.value,((e,s)=>(t(),a(f,{key:e.id,class:"message-item",style:{transform:"scaleY(-1)"}},{default:o((()=>[l(_e,{message:e,"message-index":s,"message-list":w.value},null,8,["message","message-index","message-list"])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1},8,["scroll-top"]),l(y,{bottom:""},{default:o((()=>[T.value?(t(),a(f,{key:0,class:"back-top ss-flex ss-row-center ss-m-b-10",onClick:A},{default:o((()=>[l(g,{class:"back-top-item ss-flex ss-row-center"},{default:o((()=>[n(i(x.value?"有新消息":"回到底部"),1)])),_:1})])),_:1})):v("",!0),I(r.$slots,"bottom",{},void 0,!0)])),_:3})],64)}}},[["__scopeId","data-v-56a45609"]]),Te=ie({__name:"toolsPopup",props:{toolsMode:{type:String,default:""},showTools:{type:Boolean,default:()=>!1}},emits:["onEmoji","imageSelect","onShowSelect","close"],setup(i,{emit:r}){const g=r;function f(){g("close")}function y(e){g("onShowSelect",e)}return(r,v)=>{const _=x,w=p,T=j,b=B,k=e(s("s-uploader"),re),S=e(s("su-popup"),Z);return t(),a(S,{show:i.showTools,onClose:f},{default:o((()=>[l(w,{class:"ss-modal-box ss-flex-col"},{default:o((()=>[I(r.$slots,"default",{},void 0,!0),l(w,{class:"content ss-flex ss-flex-1"},{default:o((()=>["emoji"===i.toolsMode?(t(),a(b,{key:0,class:"emoji-swiper","indicator-dots":!0,circular:"","indicator-active-color":"#7063D2","indicator-color":"rgba(235, 231, 255, 1)",autoplay:!1,interval:3e3,duration:1e3},{default:o((()=>[(t(!0),u(d,null,m(c(he),(e=>(t(),a(T,{key:e},{default:o((()=>[l(w,{class:"ss-flex ss-flex-wrap"},{default:o((()=>[(t(!0),u(d,null,m(e,(e=>(t(),a(_,{key:e,class:"emoji-img",src:c(h).$url.cdn(`/static/img/chat/emoji/${e.file}`),onClick:s=>function(e){g("onEmoji",e)}(e)},null,8,["src","onClick"])))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(t(),u(d,{key:1},[l(w,{class:"image"},{default:o((()=>[l(k,{"file-mediatype":"image",imageStyles:{width:50,height:50,border:!1},onSelect:v[0]||(v[0]=e=>{g("imageSelect",{type:"image",data:e})})},{default:o((()=>[l(_,{class:"icon",src:c(h).$url.static("/static/img/shop/chat/image.png"),mode:"aspectFill"},null,8,["src"])])),_:1}),l(w,null,{default:o((()=>[n("图片")])),_:1})])),_:1}),l(w,{class:"goods",onClick:v[1]||(v[1]=e=>y("goods"))},{default:o((()=>[l(_,{class:"icon",src:c(h).$url.static("/static/img/shop/chat/goods.png"),mode:"aspectFill"},null,8,["src"]),l(w,null,{default:o((()=>[n("商品")])),_:1})])),_:1}),l(w,{class:"order",onClick:v[2]||(v[2]=e=>y("order"))},{default:o((()=>[l(_,{class:"icon",src:c(h).$url.static("/static/img/shop/chat/order.png"),mode:"aspectFill"},null,8,["src"]),l(w,null,{default:o((()=>[n("订单")])),_:1})])),_:1})],64))])),_:1})])),_:3})])),_:3},8,["show"])}}},[["__scopeId","data-v-52e56198"]]);const xe=ie({name:"optimize-input",emits:["click","iconClick","update:modelValue","input","focus","blur","confirm"],model:{prop:"modelValue",event:"update:modelValue"},props:{name:String,value:[Number,String],modelValue:[Number,String],type:{type:String,default:"text"},clearable:{type:Boolean,default:!0},autoHeight:{type:Boolean,default:!1},placeholder:String,placeholderStyle:String,focus:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},maxlength:{type:[Number,String],default:140},confirmType:{type:String,default:"done"},clearSize:{type:[Number,String],default:15},inputBorder:{type:Boolean,default:!0},prefixIcon:{type:String,default:""},suffixIcon:{type:String,default:""},trim:{type:[Boolean,String],default:!0},passwordIcon:{type:Boolean,default:!0},styles:{type:Object,default:()=>({color:"#333",disableColor:"#F7F6F6",borderColor:"#e5e5e5"})},errorMessage:{type:[String,Boolean],default:""},paddingLeft:{type:[Number,String],default:0}},data:()=>({focused:!1,errMsg:"",val:"",showMsg:"",border:!1,isFirstBorder:!1,showClearIcon:!1,showPassword:!1}),computed:{msg(){return this.errorMessage||this.errMsg},inputMaxlength(){return Number(this.maxlength)}},watch:{value(e){this.errMsg&&(this.errMsg=""),this.val=e,this.form&&this.formItem&&!this.is_reset&&(this.is_reset=!1,this.formItem.setValue(e))},modelValue(e){this.errMsg&&(this.errMsg=""),this.val=e,this.form&&this.formItem&&!this.is_reset&&(this.is_reset=!1,this.formItem.setValue(e))},focus(e){this.$nextTick((()=>{this.focused=this.focus}))}},created(){this.value||0===this.value||(this.val=this.modelValue),this.modelValue||0===this.modelValue||(this.val=this.value),this.form=this.getForm("uniForms"),this.formItem=this.getForm("uniFormsItem"),this.form&&this.formItem&&this.formItem.name&&(this.is_reset||(this.is_reset=!1,this.formItem.setValue(this.val)),this.rename=this.formItem.name,this.form.inputChildrens.push(this))},mounted(){this.$nextTick((()=>{this.focused=this.focus}))},methods:{init(){},onClickIcon(e){this.$emit("iconClick",e)},getForm(e="uniForms"){let s=this.$parent,t=s.$options.name;for(;t!==e;){if(s=s.$parent,!s)return!1;t=s.$options.name}return s},onEyes(){this.showPassword=!this.showPassword},onInput(e){let s=e.detail.value;this.trim&&("boolean"==typeof this.trim&&this.trim&&(s=this.trimStr(s)),"string"==typeof this.trim&&(s=this.trimStr(s,this.trim))),this.errMsg&&(this.errMsg=""),this.val=s,this.$emit("input",s),this.$emit("update:modelValue",s)},onFocus(e){this.$emit("focus",e)},onBlur(e){e.detail.value,this.$emit("blur",e)},onConfirm(e){this.$emit("confirm",e.detail.value)},onClear(e){this.val="",this.$emit("input",""),this.$emit("update:modelValue","")},fieldClick(){this.$emit("click")},trimStr:(e,s="both")=>"both"===s?e.trim():"left"===s?e.trimLeft():"right"===s?e.trimRight():"start"===s?e.trimStart():"end"===s?e.trimEnd():"all"===s?e.replace(/\s+/g,""):e}},[["render",function(n,i,c,m,g,f){const h=e(s("uni-icons"),Q),y=F,_=N,w=p;return t(),a(w,{class:r(["uni-easyinput",{"uni-easyinput-error":f.msg}]),style:V({color:c.inputBorder&&f.msg?"#e43d33":c.styles.color})},{default:o((()=>[l(w,{class:r(["uni-easyinput__content",{"is-input-border":c.inputBorder,"is-input-error-border":c.inputBorder&&f.msg,"is-textarea":"textarea"===c.type,"is-disabled":c.disabled}]),style:V({"border-color":c.inputBorder&&f.msg?"#dd524d":c.styles.borderColor,"background-color":c.disabled?c.styles.disableColor:""})},{default:o((()=>[c.prefixIcon?(t(),a(h,{key:0,class:"content-clear-icon",type:c.prefixIcon,color:"#c0c4cc",onClick:i[0]||(i[0]=e=>f.onClickIcon("prefix"))},null,8,["type"])):v("",!0),"textarea"===c.type?(t(),a(y,{key:1,class:r(["uni-easyinput__content-textarea",{"input-padding":c.inputBorder}]),name:c.name,value:g.val,placeholder:c.placeholder,placeholderStyle:c.placeholderStyle,disabled:c.disabled,"placeholder-class":"uni-easyinput__placeholder-class",maxlength:f.inputMaxlength,focus:g.focused,autoHeight:c.autoHeight,"adjust-position":!1,onInput:f.onInput,onBlur:f.onBlur,onFocus:f.onFocus,onConfirm:f.onConfirm},null,8,["class","name","value","placeholder","placeholderStyle","disabled","maxlength","focus","autoHeight","onInput","onBlur","onFocus","onConfirm"])):(t(),a(_,{key:2,type:"password"===c.type?"text":c.type,class:"uni-easyinput__content-input",style:V({"padding-right":"password"===c.type||c.clearable||c.prefixIcon?"":"10px","padding-left":c.paddingLeft+"px"}),name:c.name,value:g.val,password:!g.showPassword&&"password"===c.type,placeholder:c.placeholder,placeholderStyle:c.placeholderStyle,"placeholder-class":"uni-easyinput__placeholder-class",disabled:c.disabled,maxlength:f.inputMaxlength,focus:g.focused,confirmType:c.confirmType,"adjust-position":!1,onFocus:f.onFocus,onBlur:f.onBlur,onInput:f.onInput,onChange:f.onInput,onConfirm:f.onConfirm,"cursor-spacing":30,"always-embed":""},null,8,["type","style","name","value","password","placeholder","placeholderStyle","disabled","maxlength","focus","confirmType","onFocus","onBlur","onInput","onChange","onConfirm"])),"password"===c.type&&c.passwordIcon?(t(),u(d,{key:3},[g.val?(t(),a(h,{key:0,class:r(["content-clear-icon",{"is-textarea-icon":"textarea"===c.type}]),type:g.showPassword?"eye-slash-filled":"eye-filled",size:18,color:"#c0c4cc",onClick:f.onEyes},null,8,["class","type","onClick"])):v("",!0)],64)):c.suffixIcon?(t(),u(d,{key:4},[c.suffixIcon?(t(),a(h,{key:0,class:"content-clear-icon",type:c.suffixIcon,color:"#c0c4cc",onClick:i[1]||(i[1]=e=>f.onClickIcon("suffix"))},null,8,["type"])):v("",!0)],64)):(t(),u(d,{key:5},[c.clearable&&g.val&&!c.disabled?(t(),a(h,{key:0,class:r(["content-clear-icon",{"is-textarea-icon":"textarea"===c.type}]),type:"clear",size:c.clearSize,color:"#c0c4cc",onClick:f.onClear},null,8,["class","size","onClick"])):v("",!0)],64)),I(n.$slots,"right",{},void 0,!0)])),_:3},8,["class","style"])])),_:3},8,["class","style"])}],["__scopeId","data-v-d28c46bd"]]),be=ie({__name:"messageInput",props:{modelValue:{type:String,default:""},toolsMode:{type:String,default:""}},emits:["update:modelValue","onTools","sendMessage"],setup(e,{emit:s}){const i=e,c=s,u=g({get:()=>i.modelValue,set(e){c("update:modelValue",e)}});function d(e){c("onTools",e)}function m(){c("sendMessage")}return(s,i)=>{const c=p,g=D,f=R;return t(),a(c,{class:"send-wrap ss-flex"},{default:o((()=>[l(c,{class:"left ss-flex ss-flex-1"},{default:o((()=>[l(xe,{class:"ss-flex-1 ss-p-l-22",inputBorder:!1,clearable:!1,modelValue:u.value,"onUpdate:modelValue":i[0]||(i[0]=e=>u.value=e),placeholder:"请输入你要咨询的问题"},null,8,["modelValue"])])),_:1}),l(g,{class:"sicon-basic bq",onClick:i[1]||(i[1]=O((e=>d("emoji")),["stop"]))}),u.value?v("",!0):(t(),a(g,{key:0,class:r(["sicon-edit",{"is-active":"tools"===e.toolsMode}]),onClick:i[2]||(i[2]=O((e=>d("tools")),["stop"]))},null,8,["class"])),u.value?(t(),a(f,{key:1,class:r(["ss-reset-button send-btn",{disabled:s.isDisabled||s.sending}]),onClick:m,disabled:s.isDisabled||s.sending},{default:o((()=>[s.sending?(t(),a(g,{key:0},{default:o((()=>[n("发送中")])),_:1})):(t(),a(g,{key:1},{default:o((()=>[n("发送")])),_:1}))])),_:1},8,["disabled","class"])):v("",!0)])),_:1})}}},[["__scopeId","data-v-5ff402d8"]]),ke=ie({__name:"select-popup",props:{mode:{type:String,default:"goods"},show:{type:Boolean,default:!1}},emits:["select","close"],setup(n,{emit:r}){const c=r,g=n;L((()=>g.mode),(()=>{f.pagination.data=[],g.mode&&h(f.pagination.page)}));const f=S({loadStatus:"",pagination:{data:[],current_page:1,total:1,last_page:1}});async function h(e,s=5){f.loadStatus="loading";const t="goods"==g.mode?await z.getBrowseHistoryPage({page:e,list_rows:s}):await A.getOrderPage({page:e,list_rows:s});let a=ue(f.pagination.data,t.data.list);f.pagination={...t.data,data:a},f.pagination.current_page<f.pagination.last_page?f.loadStatus="more":f.loadStatus="noMore"}function y(){"noMore"!==f.loadStatus&&h(f.pagination.current_page+1)}return(r,g)=>{const h=p,_=e(s("uni-load-more"),ce),w=E,T=e(s("su-popup"),Z);return t(),a(T,{show:n.show,showClose:"",round:"10",backgroundColor:"#eee",onClose:g[0]||(g[0]=e=>c("close"))},{default:o((()=>[l(h,{class:"select-popup"},{default:o((()=>[l(h,{class:"title"},{default:o((()=>[P("span",null,i("goods"==n.mode?"我的浏览":"我的订单"),1)])),_:1}),l(w,{class:"scroll-box","scroll-y":"true","scroll-with-animation":!0,"show-scrollbar":!1,onScrolltolower:y},{default:o((()=>[(t(!0),u(d,null,m(f.pagination.data,(e=>(t(),a(h,{class:"item",key:e.id,onClick:s=>c("select",{type:n.mode,data:e})},{default:o((()=>["goods"==n.mode?(t(),a(ye,{key:0,goodsData:e},null,8,["goodsData"])):v("",!0),"order"==n.mode?(t(),a(ve,{key:1,orderData:e},null,8,["orderData"])):v("",!0)])),_:2},1032,["onClick"])))),128)),l(_,{status:f.loadStatus,"content-text":{contentdown:"上拉加载更多"}},null,8,["status"])])),_:1})])),_:1})])),_:1},8,["show"])}}},[["__scopeId","data-v-333f5a53"]]);function Se(e){const s=S({url:(U+H).replace("http","ws")+"?token="+Y(),isReconnecting:!1,reconnectInterval:3e3,heartBeatInterval:5e3,pingTimeoutDuration:1e3,heartBeatTimer:null,destroy:!1,pingTimeout:null,reconnectTimeout:null,onConnected:()=>{},onClosed:()=>{},onMessage:e=>{}}),t=k(null),a=()=>{s.heartBeatTimer=setInterval((()=>{var e;e="ping",t.value&&!s.destroy&&t.value.send({data:e}),s.pingTimeout=setTimeout((()=>{l()}),s.pingTimeoutDuration)}),s.heartBeatInterval)},o=()=>{clearInterval(s.heartBeatTimer),n()},l=()=>{!s.destroy&&t.value&&(s.isReconnecting=!0,s.reconnectTimeout&&clearTimeout(s.reconnectTimeout),s.reconnectTimeout=setTimeout((()=>{s.destroy||(s.isReconnecting=!1,i())}),s.reconnectInterval))},n=()=>{s.pingTimeout&&(clearTimeout(s.pingTimeout),s.pingTimeout=null)},i=()=>{s.destroy=!1,X(s,e),t.value=G({url:s.url,complete:()=>{},success:()=>{}}),t.value.onOpen((()=>{console.log("WebSocket 连接成功"),s.onConnected(),a()})),t.value.onMessage((e=>{try{"pong"===e.data?n():s.onMessage(JSON.parse(e.data))}catch(t){console.error(t)}})),t.value.onClose((e=>{s.destroy?s.onClosed():(o(),l())}))};return i(),q((()=>{s.destroy=!0,o(),s.reconnectTimeout&&clearTimeout(s.reconnectTimeout),t.value&&(t.value.close(),t.value=null)})),{options:s}}const Me=ie({__name:"index",setup(n){const i=h.$platform.navbar,r=S({msg:"",scrollInto:"",showTools:!1,toolsMode:"",showSelect:!1,selectMode:""});async function u(){if(r.msg)try{const e={contentType:de.TEXT,content:JSON.stringify({text:r.msg})};await C.sendKefuMessage(e),r.msg=""}finally{r.showTools=!1}}const d=k();function m(){r.showTools=!1,r.toolsMode=""}function g(e){r.msg+=e.name}function y(e){T.value?h.$helper.toast("您已掉线！请返回重试"):r.showTools&&r.toolsMode===e?m():(r.showTools&&r.toolsMode!==e&&(r.showTools=!1,r.toolsMode=""),setTimeout((()=>{r.toolsMode=e,r.showTools=!0}),200))}function v(e){r.showTools=!1,r.showSelect=!0,r.selectMode=e}async function _({type:e,data:s}){let t;switch(e){case"image":const e=await K.uploadFile(s.tempFiles[0].path);t={contentType:de.IMAGE,content:JSON.stringify({picUrl:e.data})};break;case"goods":t={contentType:de.PRODUCT,content:JSON.stringify(s)};break;case"order":t={contentType:de.ORDER,content:JSON.stringify(s)}}t&&(await C.sendKefuMessage(t),await d.value.refreshMessageList(),r.showTools=!1,r.showSelect=!1,r.selectMode="")}const{options:w}=Se({onConnected:async()=>{},onMessage:async e=>{const s=e.type;s?s!==pe?s===ge&&(console.log("管理员已读消息"),h.$helper.toast("客服已读您的消息")):await d.value.refreshMessageList(f(e.content)):console.error("未知的消息类型："+e)}}),T=J(w).isReconnecting;return(n,f)=>{const h=p,w=e(s("s-layout"),ee);return t(),a(w,{class:"chat-wrap",title:c(T)?"会话重连中":"连接客服成功",navbar:"inner"},{default:o((()=>[l(h,{class:"page-bg",style:V({height:c(i)+"px"})},null,8,["style"]),l(we,{ref_key:"messageListRef",ref:d},{bottom:o((()=>[l(be,{modelValue:r.msg,"onUpdate:modelValue":f[0]||(f[0]=e=>r.msg=e),onOnTools:y,onSendMessage:u,"auto-focus":!1,"show-char-count":!0,"max-length":500},null,8,["modelValue"])])),_:1},512),l(Te,{"show-tools":r.showTools,"tools-mode":r.toolsMode,onClose:m,onOnEmoji:g,onImageSelect:_,onOnShowSelect:v},{default:o((()=>[l(be,{modelValue:r.msg,"onUpdate:modelValue":f[1]||(f[1]=e=>r.msg=e),onOnTools:y,onSendMessage:u,"auto-focus":!1,"show-char-count":!0,"max-length":500},null,8,["modelValue"])])),_:1},8,["show-tools","tools-mode"]),l(ke,{mode:r.selectMode,show:r.showSelect,onSelect:_,onClose:f[2]||(f[2]=e=>r.showSelect=!1)},null,8,["mode","show"])])),_:1},8,["title"])}}},[["__scopeId","data-v-d13f77e7"]]);export{Me as default};
