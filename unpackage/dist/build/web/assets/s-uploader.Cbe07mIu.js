import{af as e,br as t,s,aD as i,j as l,f as a,w as o,l as r,F as n,m as d,y as h,k as u,D as c,g as p,T as f,q as m,i as y,A as g,p as b,t as F,bS as x,an as _,bd as k,G as w,H as I}from"./index-DugDUeNE.js";import{t as S,c as $,u as v}from"./choose-and-upload-file.DF1pkorH.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";const T=e=>{const t=e.lastIndexOf("."),s=e.length;return{name:e.substring(0,t),ext:e.substring(t+1,s)}},C=e=>{if(Array.isArray(e))return e;return e.replace(/([\[\]])/g,"").split(",")},P=async(e,s="image")=>{const i=T(e.name).ext.toLowerCase();let l={name:e.name,uuid:e.uuid,extname:i||"",cloudPath:e.cloudPath,fileType:e.fileType,url:e.url||e.path,size:e.size,image:{},path:e.path,video:{}};if("image"===s){const s=await(a=e.path,new Promise(((e,s)=>{t({src:a,success(t){e(t)},fail(e){s(e)}})})));delete l.video,l.image.width=s.width,l.image.height=s.height,l.image.location=s.path}else delete l.image;var a;return l};const j=L({name:"sUploader",components:{uploadImage:L({name:"uploadImage",emits:["uploadFiles","choose","delFile"],props:{filesList:{type:[Array,String],default:()=>[]},disabled:{type:Boolean,default:!1},disablePreview:{type:Boolean,default:!1},limit:{type:[Number,String],default:9},imageStyles:{type:Object,default:()=>({width:"auto",height:"auto",border:{}})},delIcon:{type:Boolean,default:!0},readonly:{type:Boolean,default:!1}},computed:{list(){return"string"==typeof this.filesList?this.filesList?[this.filesList]:[]:this.filesList},styles(){return Object.assign({width:"auto",height:"auto",border:{}},this.imageStyles)},boxStyle(){const{width:e="auto",height:t="auto"}=this.styles;let s={};"auto"===t?"auto"!==e?(s.height=this.value2px(e),s["padding-top"]=0):s.height=0:(s.height=this.value2px(t),s["padding-top"]=0),s.width="auto"===e?"auto"!==t?this.value2px(t):"33.3%":this.value2px(e);let i="";for(let l in s)i+=`${l}:${s[l]};`;return i},borderStyle(){let{border:e}=this.styles,t={};if("boolean"==typeof e)t.border=e?"1px #eee solid":"none";else{let s=e&&e.width||1;s=this.value2px(s);let i=e&&e.radius||3;i=this.value2px(i),t={"border-width":s,"border-style":e&&e.style||"solid","border-color":e&&e.color||"#eee","border-radius":i}}let s="";for(let i in t)s+=`${i}:${t[i]};`;return s}},methods:{getImageUrl:e=>"blob:http:"===e.substr(0,10)?e:s.$url.cdn(e),uploadFiles(e,t){this.$emit("uploadFiles",e)},choose(){this.$emit("choose")},delFile(e){this.$emit("delFile",e)},previewImage(e,t){let s=[];1===Number(this.limit)&&this.disablePreview&&!this.disabled&&this.$emit("choose"),this.disablePreview||(this.list.forEach((e=>{s.push(this.getImageUrl(e))})),i({urls:s,current:t}))},value2px:e=>("number"==typeof e?e+="px":-1===e.indexOf("%")&&(e=-1!==e.indexOf("px")?e:e+"px"),e)}},[["render",function(e,t,s,i,g,b){const F=m,x=y;return l(),a(x,{class:"uni-file-picker__container"},{default:o((()=>[(l(!0),r(n,null,d(b.list,((e,t)=>(l(),a(x,{class:"file-picker__box",key:t,style:h(b.boxStyle)},{default:o((()=>[u(x,{class:"file-picker__box-content",style:h(b.borderStyle)},{default:o((()=>[u(F,{class:"file-image",src:b.getImageUrl(e),mode:"aspectFill",onClick:c((s=>b.previewImage(e,t)),["stop"])},null,8,["src","onClick"]),s.delIcon&&!s.readonly?(l(),a(x,{key:0,class:"icon-del-box",onClick:c((e=>b.delFile(t)),["stop"])},{default:o((()=>[u(x,{class:"icon-del"}),u(x,{class:"icon-del rotate"})])),_:2},1032,["onClick"])):p("",!0)])),_:2},1032,["style"])])),_:2},1032,["style"])))),128)),b.list.length<s.limit&&!s.readonly?(l(),a(x,{key:0,class:"file-picker__box",style:h(b.boxStyle)},{default:o((()=>[u(x,{class:"file-picker__box-content is-add",style:h(b.borderStyle),onClick:b.choose},{default:o((()=>[f(e.$slots,"default",{},(()=>[u(x,{class:"icon-add"}),u(x,{class:"icon-add rotate"})]),!0)])),_:3},8,["style","onClick"])])),_:3},8,["style"])):p("",!0)])),_:3})}],["__scopeId","data-v-948a7290"]]),uploadFile:L({name:"uploadFile",emits:["uploadFiles","choose","delFile"],props:{filesList:{type:Array,default:()=>[]},delIcon:{type:Boolean,default:!0},limit:{type:[Number,String],default:9},showType:{type:String,default:""},listStyles:{type:Object,default:()=>({border:!0,dividline:!0,borderStyle:{}})},readonly:{type:Boolean,default:!1}},computed:{list(){let e=[];return this.filesList.forEach((t=>{e.push(t)})),e},styles(){return Object.assign({border:!0,dividline:!0,"border-style":{}},this.listStyles)},borderStyle(){let{borderStyle:e,border:t}=this.styles,s={};if(t){let t=e&&e.width||1;t=this.value2px(t);let i=e&&e.radius||5;i=this.value2px(i),s={"border-width":t,"border-style":e&&e.style||"solid","border-color":e&&e.color||"#eee","border-radius":i}}else s.border="none";let i="";for(let l in s)i+=`${l}:${s[l]};`;return i},borderLineStyle(){let e={},{borderStyle:t}=this.styles;if(t&&t.color&&(e["border-color"]=t.color),t&&t.width){let s=t&&t.width||1,i=t&&t.style||0;"number"==typeof s?s+="px":s=s.indexOf("px")?s:s+"px",e["border-width"]=s,"number"==typeof i?i+="px":i=i.indexOf("px")?i:i+"px",e["border-top-style"]=i}let s="";for(let i in e)s+=`${i}:${e[i]};`;return s}},methods:{uploadFiles(e,t){this.$emit("uploadFiles",{item:e,index:t})},choose(){this.$emit("choose")},delFile(e){this.$emit("delFile",e)},value2px:e=>("number"==typeof e?e+="px":e=-1!==e.indexOf("px")?e:e+"px",e)}},[["render",function(e,t,s,i,m,_){const k=y,w=x;return l(),a(k,{class:"uni-file-picker__files"},{default:o((()=>[s.readonly?p("",!0):(l(),a(k,{key:0,class:"files-button",onClick:_.choose},{default:o((()=>[f(e.$slots,"default",{},void 0,!0)])),_:3},8,["onClick"])),_.list.length>0?(l(),a(k,{key:1,class:"uni-file-picker__lists is-text-box",style:h(_.borderStyle)},{default:o((()=>[(l(!0),r(n,null,d(_.list,((e,t)=>(l(),a(k,{class:g(["uni-file-picker__lists-box",{"files-border":0!==t&&_.styles.dividline}]),key:t,style:h(0!==t&&_.styles.dividline&&_.borderLineStyle)},{default:o((()=>[u(k,{class:"uni-file-picker__item"},{default:o((()=>[u(k,{class:"files__name"},{default:o((()=>[b(F(e.name),1)])),_:2},1024),s.delIcon&&!s.readonly?(l(),a(k,{key:0,class:"icon-del-box icon-files",onClick:e=>_.delFile(t)},{default:o((()=>[u(k,{class:"icon-del icon-files"}),u(k,{class:"icon-del rotate"})])),_:2},1032,["onClick"])):p("",!0)])),_:2},1024),e.progress&&100!==e.progress||0===e.progress?(l(),a(k,{key:0,class:"file-picker__progress"},{default:o((()=>[u(w,{class:"file-picker__progress-item",percent:-1===e.progress?0:e.progress,"stroke-width":"4",backgroundColor:e.errMsg?"#ff5a5f":"#EBEBEB"},null,8,["percent","backgroundColor"])])),_:2},1024)):p("",!0),"error"===e.status?(l(),a(k,{key:1,class:"file-picker__mask",onClick:c((s=>_.uploadFiles(e,t)),["stop"])},{default:o((()=>[b(" 点击重试 ")])),_:2},1032,["onClick"])):p("",!0)])),_:2},1032,["class","style"])))),128))])),_:1},8,["style"])):p("",!0)])),_:3})}],["__scopeId","data-v-d33782e5"]])},options:{virtualHost:!0},emits:["select","success","fail","progress","delete","update:modelValue","update:url"],props:{modelValue:{type:[Array,Object],default:()=>[]},url:{type:[Array,String],default:()=>[]},disabled:{type:Boolean,default:!1},disablePreview:{type:Boolean,default:!1},delIcon:{type:Boolean,default:!0},autoUpload:{type:Boolean,default:!0},limit:{type:[Number,String],default:9},mode:{type:String,default:"grid"},fileMediatype:{type:String,default:"image"},fileExtname:{type:[Array,String],default:()=>[]},title:{type:String,default:""},listStyles:{type:Object,default:()=>({border:!0,dividline:!0,borderStyle:{}})},imageStyles:{type:Object,default:()=>({width:"auto",height:"auto"})},readonly:{type:Boolean,default:!1},sizeType:{type:Array,default:()=>["original","compressed"]},driver:{type:String,default:"local"},subtitle:{type:String,default:""}},data:()=>({files:[],localValue:[],imgsrc:s.$url.static("/static/img/shop/upload-camera.png")}),watch:{modelValue:{handler(e,t){this.setValue(e,t)},immediate:!0}},computed:{returnType(){return this.limit>1?"array":"object"},filesList(){let e=[];return this.files.forEach((t=>{e.push(t)})),e},showType(){return"image"===this.fileMediatype?this.mode:"list"},limitLength(){return"object"===this.returnType?1:this.limit?this.limit>=9?9:this.limit:1}},created(){"local"===this.driver&&(S.chooseAndUploadFile=$),this.form=this.getForm("uniForms"),this.formItem=this.getForm("uniFormsItem"),this.form&&this.formItem&&this.formItem.name&&(this.rename=this.formItem.name,this.form.inputChildrens.push(this))},methods:{clearFiles(e){0===e||e?this.files.splice(e,1):(this.files=[],this.$nextTick((()=>{this.setEmit()}))),this.$nextTick((()=>{this.setEmit()}))},upload(){let e=[];return this.files.forEach(((t,s)=>{"ready"!==t.status&&"error"!==t.status||e.push(Object.assign({},t))})),this.uploadFiles(e)},async setValue(e,t){const s=async e=>{let t="";return t=e.fileID?e.fileID:e.url,/cloud:\/\/([\w.]+\/?)\S*/.test(t)&&(e.fileID=t,e.url=await this.getTempFileURL(t)),e.url&&(e.path=e.url),e};if("object"===this.returnType)e?await s(e):e={};else{e||(e=[]);for(let t=0;t<e.length;t++){let i=e[t];await s(i)}}this.localValue=e,this.form&&this.formItem&&!this.is_reset&&(this.is_reset=!1,this.formItem.setValue(this.localValue));let i=Object.keys(e).length>0?e:[];this.files=[].concat(i)},choose(){this.disabled||(this.files.length>=Number(this.limitLength)&&"grid"!==this.showType&&"array"===this.returnType?e({title:`您最多选择 ${this.limitLength} 个文件`,icon:"none"}):this.chooseFiles())},async chooseFiles(){const e=C(this.fileExtname);await $({type:this.fileMediatype,compressed:!1,sizeType:this.sizeType,extension:e.length>0?e:void 0,count:this.limitLength-this.files.length,onChooseFile:this.chooseFileCallback,onUploadProgress:e=>{this.setProgress(e,e.index)}}).then((e=>{this.setSuccessAndError(e)})).catch((e=>{console.log("选择失败",e)}))},async chooseFileCallback(t){const s=C(this.fileExtname);(1===Number(this.limitLength)&&this.disablePreview&&!this.disabled||"object"===this.returnType)&&(this.files=[]);let{filePaths:i,files:l}=((t,s)=>{let i=[],l=[];return s&&0!==s.length?(t.tempFiles.forEach((e=>{const t=T(e.name).ext.toLowerCase();-1!==s.indexOf(t)&&(l.push(e),i.push(e.path))})),l.length!==t.tempFiles.length&&e({title:`当前选择了${t.tempFiles.length}个文件 ，${t.tempFiles.length-l.length} 个文件格式不正确`,icon:"none",duration:5e3}),{filePaths:i,files:l}):{filePaths:i,files:l}})(t,s);s&&s.length>0||(i=t.tempFilePaths,l=t.tempFiles);let a=[];for(let e=0;e<l.length&&!(this.limitLength-this.files.length<=0);e++){l[e].uuid=Date.now();let t=await P(l[e],this.fileMediatype);t.progress=0,t.status="ready",this.files.push(t),a.push({...t,file:l[e]})}this.$emit("select",{tempFiles:a,tempFilePaths:i}),t.tempFiles=l,this.autoUpload||(t.tempFiles=[])},uploadFiles(e){return e=[].concat(e),v.call(this,e,5,(e=>{this.setProgress(e,e.index,!0)})).then((e=>(this.setSuccessAndError(e),e))).catch((e=>{console.log(e)}))},async setSuccessAndError(e,t){let s=[],i=[],l=[],a=[];for(let o=0;o<e.length;o++){const t=e[o],r=t.uuid?this.files.findIndex((e=>e.uuid===t.uuid)):t.index;if(-1===r||!this.files)break;if("request:fail"===t.errMsg)this.files[r].url=t.url,this.files[r].status="error",this.files[r].errMsg=t.errMsg,i.push(this.files[r]),a.push(this.files[r].url);else{this.files[r].errMsg="",this.files[r].fileID=t.url;/cloud:\/\/([\w.]+\/?)\S*/.test(t.url)?this.files[r].url=await this.getTempFileURL(t.url):this.files[r].url=t.url,this.files[r].status="success",this.files[r].progress+=1,s.push(this.files[r]),l.push(this.files[r].fileID)}}s.length>0&&(this.setEmit(),this.$emit("success",{tempFiles:this.backObject(s),tempFilePaths:l})),i.length>0&&this.$emit("fail",{tempFiles:this.backObject(i),tempFilePaths:a})},setProgress(e,t,s){this.files.length;const i=Math.round(100*e.loaded/e.total);let l=t;s||(l=this.files.findIndex((t=>t.uuid===e.tempFile.uuid))),-1!==l&&this.files[l]&&(this.files[l].progress=i-1,this.$emit("progress",{index:l,progress:parseInt(i),tempFile:this.files[l]}))},delFile(e){_(this.files)?this.$emit("delete",{tempFilePath:this.url}):(this.$emit("delete",{tempFile:this.files[e],tempFilePath:this.files[e].url}),this.files.splice(e,1)),this.$nextTick((()=>{this.setEmit()}))},getFileExt(e){const t=e.lastIndexOf("."),s=e.length;return{name:e.substring(0,t),ext:e.substring(t+1,s)}},setEmit(){let e=[],t=[];"object"===this.returnType?(e=this.backObject(this.files)[0],this.localValue=e||null,t=e?e.url:""):(e=this.backObject(this.files),this.localValue||(this.localValue=[]),this.localValue=[...e],this.localValue.length>0&&this.localValue.forEach((e=>{t.push(e.url)}))),this.$emit("update:modelValue",this.localValue),this.$emit("update:url",t)},backObject(e){let t=[];return e.forEach((e=>{t.push({extname:e.extname,fileType:e.fileType,image:e.image,name:e.name,path:e.path,size:e.size,fileID:e.fileID,url:e.url})})),t},async getTempFileURL(e){e={fileList:[].concat(e)};return(await S.getTempFileURL(e)).fileList[0].tempFileURL||""},getForm(e="uniForms"){let t=this.$parent,s=t.$options.name;for(;s!==e;){if(t=t.$parent,!t)return!1;s=t.$options.name}return t}}},[["render",function(e,t,s,i,r,n){const d=w,h=y,c=m,g=k("upload-image"),x=I,_=k("upload-file");return l(),a(h,{class:"uni-file-picker"},{default:o((()=>[s.title?(l(),a(h,{key:0,class:"uni-file-picker__header"},{default:o((()=>[u(d,{class:"file-title"},{default:o((()=>[b(F(s.title),1)])),_:1}),u(d,{class:"file-count"},{default:o((()=>[b(F(n.filesList.length)+"/"+F(n.limitLength),1)])),_:1})])),_:1})):p("",!0),s.subtitle?(l(),a(h,{key:1,class:"file-subtitle"},{default:o((()=>[u(h,null,{default:o((()=>[b(F(s.subtitle),1)])),_:1})])),_:1})):p("",!0),"image"===s.fileMediatype&&"grid"===n.showType?(l(),a(g,{key:2,readonly:s.readonly,"image-styles":s.imageStyles,"files-list":s.url,limit:n.limitLength,disablePreview:s.disablePreview,delIcon:s.delIcon,onUploadFiles:n.uploadFiles,onChoose:n.choose,onDelFile:n.delFile},{default:o((()=>[f(e.$slots,"default",{},(()=>[u(h,{class:"is-add"},{default:o((()=>[u(c,{src:r.imgsrc,class:"add-icon"},null,8,["src"])])),_:1})]),!0)])),_:3},8,["readonly","image-styles","files-list","limit","disablePreview","delIcon","onUploadFiles","onChoose","onDelFile"])):p("",!0),"image"!==s.fileMediatype||"grid"!==n.showType?(l(),a(_,{key:3,readonly:s.readonly,"list-styles":s.listStyles,"files-list":n.filesList,showType:n.showType,delIcon:s.delIcon,onUploadFiles:n.uploadFiles,onChoose:n.choose,onDelFile:n.delFile},{default:o((()=>[f(e.$slots,"default",{},(()=>[u(x,{type:"primary",size:"mini"},{default:o((()=>[b("选择文件")])),_:1})]),!0)])),_:3},8,["readonly","list-styles","files-list","showType","delIcon","onUploadFiles","onChoose","onDelFile"])):p("",!0)])),_:3})}],["__scopeId","data-v-94211b2d"]]);export{j as _};
